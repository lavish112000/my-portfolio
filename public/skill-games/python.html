<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonic Temple Quest - 2D Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../public/skill-games/python.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
</head>
</head>
<body>

    <!-- LANDING PAGE -->
    <div id="landing-page" class="fullscreen-container">
        <div class="text-box">
            <div class="avatar"></div>
            <h2>Welcome, Seeker of Knowledge</h2>
            <p style="animation-delay: 1.5s;">You stand at the entrance of the Pythonic Temple.</p>
            <p style="animation-delay: 2.5s;">Here, the ancient language of Python is not just code... it's magic. It builds worlds, powers intelligent artifacts, and unlocks the secrets of data.</p>
            <p style="animation-delay: 3.5s;">Your quest, should you choose to accept it, is to master the core spells.</p>
            <button id="start-button" class="action-button">Begin Quest</button>
        </div>
    </div>

    <!-- GAME AREA (Initially hidden) -->
    <div id="game-area">
        <div id="game-container">
            
            <div id="snake-chatbot-container">
                <canvas id="chatbot-canvas"></canvas>
                <div id="chatbot-ui">
                    <div id="snake-speech-bubble">Ask me a question...</div>
                    <input type="text" id="chatbot-input" placeholder="e.g., What is a list?">
                </div>
            </div>

            <div id="info-panel">
                <div id="info-panel-header">
                    <h1 id="level-title"></h1>
                    <div>
                        <button id="hint-button" class="info-button">?</button>
                        <button id="minimize-button" class="info-button">-</button>
                    </div>
                </div>
                <p id="level-instruction"></p>
            </div>
            
            <div id="pedestal-area"></div>
            <div id="block-area"></div>
            <div id="controls-area">
                <button id="action-button">Activate</button>
            </div>
        </div>
        <div id="message-box" onclick="if(this.dataset.action === 'nextLevel') advanceLevel()"></div>
    </div>

    <!-- OUTRO PAGE (Initially hidden) -->
    <div id="outro-page" class="fullscreen-container">
        <div class="text-box">
            <div class="avatar"></div>
            <h2>Your Quest is Complete!</h2>
            <p>You have mastered the fundamental spells of Python. Your journey as a developer has only just begun.</p>
            <p><b>An interesting fact:</b> Python was not named after the snake! Its creator, Guido van Rossum, named it after the British comedy group "Monty Python's Flying Circus".</p>
            <p>Thank you for playing!</p>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const landingPage = document.getElementById('landing-page');
        const startButton = document.getElementById('start-button');
        const gameArea = document.getElementById('game-area');
        const outroPage = document.getElementById('outro-page');
        const pedestalArea = document.getElementById('pedestal-area');
        const blockArea = document.getElementById('block-area');
        const actionButton = document.getElementById('action-button');
        const messageBox = document.getElementById('message-box');
        const infoPanel = document.getElementById('info-panel');
        const minimizeButton = document.getElementById('minimize-button');
        const hintButton = document.getElementById('hint-button');
        const chatbotCanvas = document.getElementById('chatbot-canvas');
        const chatbotInput = document.getElementById('chatbot-input');
        const speechBubble = document.getElementById('snake-speech-bubble');

        // --- SOUND SETUP ---
        const clickSynth = new Tone.PolySynth(Tone.MetalSynth, { frequency: 400, envelope: { attack: 0.001, decay: 0.1, release: 0.1 }, harmonicity: 3.1, modulationIndex: 16, resonance: 4000, octaves: 1.5 }).toDestination();
        const pickupSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const dropSynth = new Tone.PolySynth(Tone.MembraneSynth, { pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' } }).toDestination();
        const successSynth = new Tone.PolySynth(Tone.FMSynth, { harmonicity: 8, modulationIndex: 2, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 2, sustain: 0.1, release: 2 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
        const failSynth = new Tone.PolySynth(Tone.AMSynth, { harmonicity: 1.5, detune: 0, oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }, modulation: { type: "sawtooth" }, modulationEnvelope: { attack: 0.5, decay: 0.01, sustain: 1, release: 0.5 } }).toDestination();
        const messageSynth = new Tone.PolySynth(Tone.FMSynth, { harmonicity: 3.01, modulationIndex: 14, detune: 0, oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }, modulation: { type: "triangle" }, modulationEnvelope: { attack: 0.02, decay: 0.5, sustain: 0, release: 0.5 } }).toDestination();

        const sounds = {
            click: () => clickSynth.triggerAttackRelease("C6", "8n"),
            pickup: () => pickupSynth.triggerAttackRelease("C4", "8n"),
            drop: () => dropSynth.triggerAttackRelease("C3", "8n"),
            success: () => successSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n", Tone.now()),
            fail: () => failSynth.triggerAttackRelease("C2", "4n"),
            message: () => messageSynth.triggerAttackRelease("G5", "8n"),
            hint: () => messageSynth.triggerAttackRelease("A5", "8n"),
        };

        // --- GAME STATE ---
        let currentLevel = 0;
        let draggedBlock = null;
        
        const levels = [
            { title: "Level 1: The Golden Variable", instruction: "Create a variable named 'treasure' with the value 'gold', then print it.", blockTexts: ["print(treasure)", "treasure = 'gold'"], solution: ["treasure = 'gold'", "print(treasure)"] },
            { title: "Level 2: Data Types", instruction: "Combine the message and the number of gems. You must convert the number to a string first!", blockTexts: ["message + ", "str(gem_count)", "gem_count = 10"], solution: ["gem_count = 10", "message + ", "str(gem_count)"] },
            { title: "Level 3: Conditional Logic", instruction: "Use an 'if' statement to check if the key is correct, then print the success message.", blockTexts: ["if key == 'ancient':", "print('Door Unlocked')", "key = 'ancient'"], solution: ["key = 'ancient'", "if key == 'ancient':", "print('Door Unlocked')"] },
            { title: "Level 4: Creating Lists", instruction: "A list can hold many items. Create a list of gems.", blockTexts: ["gems = [", "'ruby',", "'emerald',", "'diamond'", "]"], solution: ["gems = [", "'ruby',", "'emerald',", "'diamond'", "]"], hint: "The square bracket `[` is the start of a list." },
            { title: "Level 5: The For Loop", instruction: "Use a 'for' loop to print each gem from your list, one by one.", blockTexts: ["for gem in gems:", "print(gem)"], solution: ["for gem in gems:", "print(gem)"], hint: "A 'for' loop repeats an action for every item in a list." }
        ];

        // --- CHATBOT SNAKE ANIMATION ---
        const chatbotCtx = chatbotCanvas.getContext('2d');
        let chatbotAngle = 0;
        function animateChatbotSnake() {
            chatbotCanvas.width = chatbotCanvas.offsetWidth;
            chatbotCanvas.height = chatbotCanvas.offsetHeight;
            chatbotCtx.clearRect(0, 0, chatbotCanvas.width, chatbotCanvas.height);
            const centerX = chatbotCanvas.width / 2;
            const centerY = chatbotCanvas.height / 2;
            
            chatbotAngle += 0.05;
            
            const segments = 10;
            for(let i = 0; i < segments; i++) {
                const x = centerX + Math.sin(chatbotAngle + i * 0.5) * 10;
                const y = centerY - 20 + i * 6;
                const radius = 8 - i * 0.5;
                chatbotCtx.beginPath();
                chatbotCtx.arc(x, y, radius, 0, Math.PI * 2);
                chatbotCtx.fillStyle = `rgba(0, 255, 127, ${1 - i * 0.05})`;
                chatbotCtx.fill();
            }
            
            const headX = centerX + Math.sin(chatbotAngle) * 10;
            const headY = centerY - 20;
            chatbotCtx.fillStyle = 'black';
            chatbotCtx.beginPath();
            chatbotCtx.arc(headX - 2, headY - 2, 1.5, 0, Math.PI*2);
            chatbotCtx.arc(headX + 2, headY - 2, 1.5, 0, Math.PI*2);
            chatbotCtx.fill();

            requestAnimationFrame(animateChatbotSnake);
        }

        // --- CORE GAME FUNCTIONS ---
        function loadLevel(levelIndex) {
            const level = levels[levelIndex];
            pedestalArea.innerHTML = ''; blockArea.innerHTML = '';
            document.getElementById('level-title').textContent = level.title;
            document.getElementById('level-instruction').textContent = level.instruction;
            
            if (level.hint) {
                hintButton.style.display = 'flex';
            } else {
                hintButton.style.display = 'none';
            }

            level.solution.forEach(() => {
                const pedestal = document.createElement('div');
                pedestal.classList.add('pedestal');
                addPedestalListeners(pedestal);
                pedestalArea.appendChild(pedestal);
            });
            level.blockTexts.sort(() => Math.random() - 0.5).forEach(text => {
                const block = document.createElement('div');
                block.classList.add('code-block');
                block.textContent = text;
                block.draggable = true;
                addBlockListeners(block);
                blockArea.appendChild(block);
            });
        }

        function addBlockListeners(block) {
            block.addEventListener('dragstart', () => { sounds.pickup(); draggedBlock = block; setTimeout(() => block.classList.add('dragging'), 0); });
            block.addEventListener('dragend', () => { draggedBlock.classList.remove('dragging'); draggedBlock = null; });
        }

        function addPedestalListeners(pedestal) {
            pedestal.addEventListener('dragover', e => { e.preventDefault(); pedestal.classList.add('over'); });
            pedestal.addEventListener('dragleave', () => { pedestal.classList.remove('over'); });
            pedestal.addEventListener('drop', () => {
                sounds.drop();
                pedestal.classList.remove('over');
                if (pedestal.children.length === 0) { pedestal.appendChild(draggedBlock); }
            });
        }

        function checkSolution() {
            const pedestals = pedestalArea.querySelectorAll('.pedestal');
            const userSolution = Array.from(pedestals).map(p => p.children.length > 0 ? p.children[0].textContent : null);
            const isCorrect = JSON.stringify(userSolution) === JSON.stringify(levels[currentLevel].solution);
            if (isCorrect) {
                sounds.success();
                if (currentLevel === levels.length - 1) {
                    showMessage("Congratulations! You've completed all levels!", true);
                    setTimeout(showOutro, 2500);
                } else {
                    showMessage("Success!", true);
                }
                pedestals.forEach(p => p.children[0]?.classList.add('success'));
            } else {
                sounds.fail();
                showMessage("Not quite right. Check the order and try again!", false);
                pedestals.forEach(p => {
                    if (p.children.length > 0) {
                        const block = p.children[0];
                        block.classList.add('fail');
                        setTimeout(() => block.classList.remove('fail'), 300);
                    }
                });
            }
        }
        
        function advanceLevel() {
            currentLevel++;
            if (currentLevel < levels.length) {
                infoPanel.style.opacity = 0;
                setTimeout(() => { loadLevel(currentLevel); infoPanel.style.opacity = 1; }, 500);
            }
            actionButton.textContent = 'Activate';
        }

        function showMessage(text, isSuccess) {
            if (!isSuccess) sounds.message();
            messageBox.textContent = text;
            messageBox.style.borderColor = isSuccess ? 'var(--success-color)' : 'var(--fail-color)';
            messageBox.style.transform = 'translate(-50%, -50%) scale(1)';
            if (isSuccess && currentLevel < levels.length - 1) {
                messageBox.dataset.action = 'nextLevel';
                messageBox.style.cursor = 'pointer';
                actionButton.textContent = 'Next Level';
            } else {
                 messageBox.dataset.action = '';
                 messageBox.style.cursor = 'default';
            }
            setTimeout(() => { messageBox.style.transform = 'translate(-50%, -50%) scale(0)'; }, isSuccess ? 2000 : 2500);
        }

        function showOutro() {
            gameArea.style.animation = 'fadeOut 0.5s ease forwards';
            gameArea.addEventListener('animationend', () => {
                gameArea.style.display = 'none';
                outroPage.style.display = 'flex';
            }, { once: true });
        }
        
        async function askTheSnake(question) {
            speechBubble.style.opacity = 1;
            speechBubble.textContent = "Hhhmm, let me think...";
            
            const prompt = `You are a wise snake in an ancient temple that teaches the Python language. A student asks you a question. Answer it in a single, concise, helpful sentence. The question is: "${question}"`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    speechBubble.textContent = text;
                    sounds.message();
                } else {
                    speechBubble.textContent = "I'm sorry, the ancient spirits are quiet right now.";
                }
            } catch (error) {
                console.error("Error asking the snake:", error);
                speechBubble.textContent = "My connection to the ether is weak... Try again.";
            }
        }


        // --- EVENT LISTENERS & INITIALIZATION ---
        startButton.addEventListener('click', async () => {
            await Tone.start();
            sounds.click();
            landingPage.style.animation = 'fadeOut 0.5s ease forwards';
            landingPage.addEventListener('animationend', () => {
                landingPage.style.display = 'none';
                gameArea.style.display = 'flex';
                gameArea.style.animation = 'fadeIn 1s ease';
                loadLevel(currentLevel);
                animateChatbotSnake();

                setTimeout(() => {
                    speechBubble.style.opacity = 1;
                }, 1000);

            }, { once: true });
        });

        actionButton.addEventListener('click', () => {
             sounds.click();
             if (actionButton.textContent === 'Next Level') { advanceLevel(); } else { checkSolution(); }
        });

        minimizeButton.addEventListener('click', () => {
            sounds.click();
            infoPanel.classList.toggle('minimized');
            minimizeButton.textContent = infoPanel.classList.contains('minimized') ? '+' : '-';
        });

        hintButton.addEventListener('click', () => {
            sounds.hint();
            const hintText = levels[currentLevel].hint;
            if (hintText) {
                showMessage(`Hint: ${hintText}`, false);
            }
        });
        
        chatbotInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && chatbotInput.value.trim() !== '') {
                sounds.click();
                askTheSnake(chatbotInput.value);
                chatbotInput.value = '';
            }
        });

        blockArea.addEventListener('dragover', e => e.preventDefault());
        blockArea.addEventListener('drop', () => { sounds.drop(); blockArea.appendChild(draggedBlock); });
        
    </script>
</body>
</html>
